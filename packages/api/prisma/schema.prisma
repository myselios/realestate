// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
}

datasource db {
  // Using Supabase which is based on PostgreSQL
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================= //
//        ğŸ¢ ì•„íŒŒíŠ¸ ë„ë©”ì¸
// ================================= //

model Region {
  id           Int         @id @default(autoincrement())
  sido         String // ì‹œ/ë„
  sigungu      String // ì‹œ/êµ°/êµ¬
  eupmyeondong String // ì/ë©´/ë™
  code         String      @unique // ì§€ì—­ ì½”ë“œ
  latitude     Float? // ì¤‘ì‹¬ ìœ„ë„
  longitude    Float? // ì¤‘ì‹¬ ê²½ë„

  apartments     Apartment[]
  busStops       BusStop[]
  developmentPlans DevelopmentPlan[]
  marketTrends   MarketTrend[]
  populationFlows PopulationFlow[]
  schools         School[]
  hospitals       Hospital[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Apartment {
  id                    String                  @id @default(cuid())
  name                  String
  address               String
  jibunAddress          String
  buildYear             Int
  latitude              Float
  longitude             Float
  regionId              Int
  region                Region                  @relation(fields: [regionId], references: [id])
  transactions          RealEstateTransaction[]
  transportationScore   TransportationScore?
  investmentAnalysis    InvestmentAnalysis?
  portfolios            Portfolio[]

  @@unique([name, jibunAddress])
  @@index([regionId])
}

model RealEstateTransaction {
  id          String   @id @default(cuid())
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id])
  tradeDate   DateTime
  price       BigInt // ê±°ë˜ ê°€ê²©
  floor       Int // ì¸µ
  area        Float // ì „ìš© ë©´ì  (m^2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ================================= //
//        ğŸš‡ êµí†µ ë„ë©”ì¸
// ================================= //

model SubwayLine {
  id         Int      @id @default(autoincrement())
  lineNumber String // '1í˜¸ì„ ', 'ë¶„ë‹¹ì„ '
  name       String   @unique
  color      String? // ë…¸ì„  ìƒ‰ìƒ (hex)
  operator   String? // ìš´ì˜ ê¸°ê´€

  stations SubwayStation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SubwayStation {
  id               Int      @id @default(autoincrement())
  name             String
  stationCode      String? // ì—­ ì½”ë“œ
  latitude         Float
  longitude        Float
  isTransfer       Boolean  @default(false)

  lineId   Int
  subwayLine SubwayLine @relation(fields: [lineId], references: [id])
  
  transportationScores TransportationScore[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, lineId])
}

model BusRoute {
  id          Int       @id @default(autoincrement())
  routeNumber String @unique
  routeType   String? // 'ê°„ì„ ', 'ì§€ì„ ', 'ê´‘ì—­'
  startPoint  String?
  endPoint    String?

  stops BusStopRoute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BusStop {
  id        Int      @id @default(autoincrement())
  name      String
  stopId    String?  @unique // ë²„ìŠ¤ì •ë¥˜ì¥ ê³ ìœ ID
  latitude  Float
  longitude Float

  regionId  Int
  region    Region   @relation(fields: [regionId], references: [id])
  routes    BusStopRoute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BusStopRoute {
  busStopId Int
  busRouteId Int

  busStop   BusStop   @relation(fields: [busStopId], references: [id])
  busRoute  BusRoute  @relation(fields: [busRouteId], references: [id])

  @@id([busStopId, busRouteId])
}

model TransportationScore {
  id                       String @id @default(cuid())
  apartmentId              String @unique
  apartment                Apartment @relation(fields: [apartmentId], references: [id])
  busStations              Json
  subwayStations           Json
  
  nearestSubwayDistance    Int? // ê°€ì¥ ê°€ê¹Œìš´ ì§€í•˜ì² ì—­ê¹Œì§€ ê±°ë¦¬(m)
  nearestSubwayId          Int?
  nearestSubway            SubwayStation? @relation(fields: [nearestSubwayId], references: [id])

  subwayCount_500m         Int      @default(0)
  subwayCount_1km          Int      @default(0)
  busStopCount_300m        Int      @default(0)
  busRouteCount            Int      @default(0)
  totalTransportationScore Int      @default(0)

  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}


// ================================= //
//      ğŸ—ï¸ ê°œë°œ/ì¬ê°œë°œ ë„ë©”ì¸
// ================================= //

model DevelopmentPlan {
  id                 Int      @id @default(autoincrement())
  planName           String
  description        String
  startDate          DateTime
  endDate            DateTime
  category           String
  status             String
  latitude           Float?
  longitude          Float?
  regionId           Int
  region             Region   @relation(fields: [regionId], references: [id])

  @@index([regionId])
}

// ================================= //
//      ğŸ“ˆ ì‹œì¥ ë™í–¥ ë„ë©”ì¸
// ================================= //

model MarketTrend {
  id                   Int      @id @default(autoincrement())
  year                 Int
  month                Int
  priceIndex           Float
  transactionVolume    Int
  unsoldInventory      Int
  constructionStarts   Int
  permitsIssued        Int
  regionId             Int
  region               Region   @relation(fields: [regionId], references: [id])

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([year, month, regionId])
}

model PopulationFlow {
  id           Int      @id @default(autoincrement())
  year         Int
  month        Int
  netMigration Int
  regionId     Int
  region       Region   @relation(fields: [regionId], references: [id])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([year, month, regionId])
}

// ================================= //
//      ğŸ“Š ì¢…í•© ë¶„ì„ ë„ë©”ì¸
// ================================= //

model InvestmentAnalysis {
  id                     String    @id @default(cuid())
  apartmentId            String    @unique
  apartment              Apartment @relation(fields: [apartmentId], references: [id])
  
  supplyScore            Int       @default(0) // S - Supply Analysis
  marketScore            Int       @default(0) // M - Market Dynamics
  accessibilityScore     Int       @default(0) // A - Accessibility
  regionalDevScore       Int       @default(0) // R - Regional Development
  trendScore             Int       @default(0) // T - Trend & Sentiment
  amenitiesScore         Int       @default(0) // A - Amenities

  totalInvestmentScore   Int       @default(0)
  
  pricePrediction_1y     BigInt?   // 1ë…„ í›„ ì˜ˆì¸¡ ê°€ê²©
  pricePrediction_3y     BigInt?   // 3ë…„ í›„ ì˜ˆì¸¡ ê°€ê²©
  predictionSummary      String?   // ë¶„ì„ ìš”ì•½ í…ìŠ¤íŠ¸
  
  lastAnalyzedAt         DateTime @updatedAt
}

// ================================= //
//        ğŸ« êµìœ¡/í¸ì˜ì‹œì„¤ ë„ë©”ì¸
// ================================= //

model School {
  id          Int      @id @default(autoincrement())
  schoolName  String
  schoolType  String // 'ì´ˆë“±í•™êµ', 'ì¤‘í•™êµ', 'ê³ ë“±í•™êµ'
  latitude    Float
  longitude   Float
  studentCount Int?
  foundingDate DateTime?

  regionId  Int
  region    Region   @relation(fields: [regionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Hospital {
  id              Int      @id @default(autoincrement())
  hospitalName    String
  hospitalType    String // 'ì¢…í•©ë³‘ì›', 'ë³‘ì›', 'ì˜ì›'
  address         String
  latitude        Float
  longitude       Float
  
  regionId  Int
  region    Region   @relation(fields: [regionId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ================================= //
//        ğŸ‘¤ ì‚¬ìš©ì ë° í¬íŠ¸í´ë¦¬ì˜¤
// ================================= //

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  name          String?
  passwordHash  String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  portfolios    Portfolio[]
}

model Portfolio {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  apartmentId   String
  apartment     Apartment   @relation(fields: [apartmentId], references: [id])
  
  memo          String?
  createdAt     DateTime    @default(now())

  @@unique([userId, apartmentId])
}
